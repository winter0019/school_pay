{% extends "layout.html" %}

{% block page_title %}Receipt Generator{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Find Payment to Generate Receipt</h3>
        
        <form id="search-form" class="space-y-4">
            <label for="student-search" class="block text-sm font-medium text-gray-700">Search Student (Name or Reg. No.)</label>
            <input type="text" id="student-search" placeholder="Start typing student name or registration number..."
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
        </form>

        <div id="search-results" class="mt-4 bg-gray-50 border border-gray-200 rounded-md max-h-60 overflow-y-auto">
        </div>

        <div id="student-info-box" class="mt-6 p-4 border-l-4 border-indigo-500 bg-indigo-50 hidden">
            <p class="font-semibold text-indigo-700">Selected Student:</p>
            <p class="text-indigo-900" id="selected-student-name"></p>
        </div>
    </div>

    <div id="payment-list-container" class="bg-white p-6 rounded-lg shadow-md hidden">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Payments for Selected Student</h3>
        
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term / Session</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                </tr>
            </thead>
            <tbody id="payments-table-body" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
        
        <p id="no-payments-message" class="text-gray-500 mt-4 hidden">No payments found for this student.</p>
    </div>
</div>

<script>
    let selectedStudentId = null;
    let searchTimeout = null;
    const searchInput = document.getElementById('student-search');
    const searchResultsDiv = document.getElementById('search-results');
    const studentInfoBox = document.getElementById('student-info-box');
    const paymentListContainer = document.getElementById('payment-list-container');
    const paymentsTableBody = document.getElementById('payments-table-body');
    const selectedStudentName = document.getElementById('selected-student-name');
    const noPaymentsMessage = document.getElementById('no-payments-message');

    // CRITICAL FIX: Generate the base URLs using the correct endpoints.
    // We use a placeholder ID (0) which the JS will replace.
    // Assuming 'view_receipt' is the HTML preview route, and 'download_receipt' is the PDF route.
    const viewReceiptBaseUrl = "{{ url_for('view_receipt', payment_id=0) }}";
    const downloadReceiptBaseUrl = "{{ url_for('download_receipt', payment_id=0) }}";

    // 1. Search Student Logic
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchResultsDiv.innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/search-students?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    searchResultsDiv.innerHTML = '';
                    if (data.students && data.students.length > 0) {
                        data.students.forEach(student => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-3 cursor-pointer hover:bg-indigo-100 border-b';
                            resultItem.textContent = `${student.name} (${student.reg_number}, ${student.student_class})`;
                            resultItem.setAttribute('data-student-id', student.id);
                            resultItem.setAttribute('data-student-name', student.name);
                            resultItem.addEventListener('click', selectStudent);
                            searchResultsDiv.appendChild(resultItem);
                        });
                    } else {
                        searchResultsDiv.innerHTML = '<div class="p-3 text-gray-500">No students found.</div>';
                    }
                })
                .catch(error => console.error('Error fetching search results:', error));
        }, 300); // 300ms debounce
    });

    // 2. Select Student Handler
    function selectStudent(event) {
        selectedStudentId = event.currentTarget.getAttribute('data-student-id');
        const name = event.currentTarget.getAttribute('data-student-name');
        
        searchInput.value = name; 
        searchResultsDiv.innerHTML = '';

        selectedStudentName.textContent = `${name} (ID: ${selectedStudentId})`;
        studentInfoBox.classList.remove('hidden');
        
        fetchPayments(selectedStudentId);
    }
    
    // 3. Fetch Payments for Selected Student
    function fetchPayments(studentId) {
        // Fetch all payments for this student
        fetch(`/student/${studentId}/payments`) 
            .then(response => {
                // Ensure successful HTTP status is treated as OK
                if (!response.ok) {
                    // Log the error but continue to parse JSON if possible, otherwise return empty array
                    console.error('API response not OK:', response.status);
                    return { payments: [] }; 
                }
                return response.json();
            })
            .then(data => {
                paymentsTableBody.innerHTML = '';
                
                if (data.payments && data.payments.length > 0) {
                    data.payments.forEach(payment => {
                        const row = document.createElement('tr');
                        
                        // ðŸ’¥ FIX APPLIED HERE: Construct URL by replacing the placeholder '0' with the actual ID.
                        const viewUrl = viewReceiptBaseUrl.replace('/0', '/' + payment.id);
                        const downloadUrl = downloadReceiptBaseUrl.replace('/0', '/' + payment.id);

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${new Date(payment.date).toLocaleDateString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">
                                â‚¦${(payment.amount_paid).toLocaleString('en-NG', { minimumFractionDigits: 2 })}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${payment.term} / ${payment.session}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <a href="${viewUrl}" 
                                   class="text-indigo-600 hover:text-indigo-900" target="_blank">View</a>
                                <span>|</span>
                                <a href="${downloadUrl}" 
                                   class="text-red-600 hover:text-red-900" target="_blank">PDF</a>
                            </td>
                        `;
                        paymentsTableBody.appendChild(row);
                    });
                    paymentListContainer.classList.remove('hidden');
                    noPaymentsMessage.classList.add('hidden');
                } else {
                    noPaymentsMessage.classList.remove('hidden');
                    paymentListContainer.classList.remove('hidden'); 
                }
            })
            .catch(error => {
                console.error('Error fetching payments:', error);
                paymentsTableBody.innerHTML = '';
                noPaymentsMessage.textContent = 'Error loading payments.';
                noPaymentsMessage.classList.remove('hidden');
                paymentListContainer.classList.remove('hidden');
            });
    }

</script>
{% endblock %}
