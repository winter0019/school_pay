{% extends 'layout.html' %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-2xl font-bold mb-6 text-center text-indigo-700">Record Payment</h2>

    <form method="POST" id="payment-form" class="space-y-4">

        <!-- Student Search -->
        <div>
            <input type="text" id="student-search" 
                   placeholder="Search student by name or reg number"
                   class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            <ul id="search-results" 
                class="border rounded mt-2 hidden max-h-48 overflow-y-auto bg-white shadow-md"></ul>
            <input type="hidden" name="student_id" id="student_id">
        </div>

        <!-- Student Info + Financials -->
        <div id="student-info" class="hidden p-4 border rounded-lg bg-gray-50">
            <p><strong>Student:</strong> <span id="student-name"></span></p>
            <p><strong>Class:</strong> <span id="student-class"></span></p>
            <hr class="my-3">
            <p class="text-sm text-gray-600 mb-1">Financial Summary (Selected Term/Session):</p>
            <p><strong>Total Fees:</strong> ₦<span id="total-fees">0.00</span></p>
            <p><strong>Total Payments:</strong> ₦<span id="previous-payments">0.00</span></p>
            <p class="font-bold text-red-600">Outstanding Balance: ₦<span id="outstanding-balance">0.00</span></p>
        </div>

        <!-- Payment Inputs -->
        <div>
            <input type="number" step="0.01" name="amount_paid" placeholder="Amount Paid (₦)"
                   class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
        </div>
        <div>
            <input type="text" name="payment_type" placeholder="Payment Type (e.g. Cash, Transfer)"
                   class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
        </div>
        <div>
            <select name="term" id="term-select" 
                    class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                <option value="">Select Term</option>
                <option value="1st Term">1st Term</option>
                <option value="2nd Term">2nd Term</option>
                <option value="3rd Term">3rd Term</option>
            </select>
        </div>
        <div>
            <input type="text" name="session" id="session-input" 
                   placeholder="Session (e.g. 2024/2025)"
                   class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submit-btn" 
                class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
            Save Payment
        </button>
    </form>
</div>

<!-- RECEIPT MODAL -->
<div id="receipt-modal" 
     class="fixed inset-0 bg-gray-800 bg-opacity-70 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
        <h3 class="text-2xl font-bold mb-4 text-center text-indigo-700">Payment Receipt</h3>
        <div id="receipt-details" class="text-sm space-y-1"></div>
        <div class="flex justify-end mt-6">
            <button id="close-receipt-modal" 
                    class="bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById("student-search");
    const resultsList = document.getElementById("search-results");
    const hiddenId = document.getElementById("student_id");
    const studentInfoDiv = document.getElementById("student-info");
    const studentNameSpan = document.getElementById("student-name");
    const studentClassSpan = document.getElementById("student-class");
    const totalFeesSpan = document.getElementById("total-fees");
    const previousPaymentsSpan = document.getElementById("previous-payments");
    const outstandingBalanceSpan = document.getElementById("outstanding-balance");
    const termSelect = document.getElementById("term-select");
    const sessionInput = document.getElementById("session-input");
    const paymentForm = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit-btn");
    const receiptModal = document.getElementById("receipt-modal");
    const receiptDetails = document.getElementById("receipt-details");
    const closeReceiptModal = document.getElementById("close-receipt-modal");

    // --- FORMAT AS CURRENCY ---
    function formatCurrency(num) {
        return Number(num).toLocaleString("en-NG", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- FETCH STUDENT FINANCIALS ---
    async function fetchStudentFinancials() {
        const studentId = hiddenId.value;
        const term = termSelect.value;
        const session = sessionInput.value;

        if (!studentId || !term || !session) {
            studentInfoDiv.classList.add("hidden");
            return;
        }

        totalFeesSpan.textContent = "Loading...";
        previousPaymentsSpan.textContent = "Loading...";
        outstandingBalanceSpan.textContent = "Loading...";

        try {
            const res = await fetch(`/student-financials?student_id=${studentId}&term=${term}&session=${session}`);
            const data = await res.json();

            if (data.error) {
                alert(data.error);
                studentInfoDiv.classList.add("hidden");
            } else {
                totalFeesSpan.textContent = formatCurrency(data.total_fee);
                previousPaymentsSpan.textContent = formatCurrency(data.total_paid);
                outstandingBalanceSpan.textContent = formatCurrency(data.outstanding);
                studentInfoDiv.classList.remove("hidden");
            }
        } catch (err) {
            alert("⚠️ Error fetching financials. Please try again.");
        }
    }

    // --- SEARCH STUDENTS ---
    searchInput.addEventListener("input", async function() {
        const q = this.value.trim();
        if (q.length < 2) {
            resultsList.innerHTML = "";
            resultsList.classList.add("hidden");
            studentInfoDiv.classList.add("hidden");
            return;
        }

        try {
            const res = await fetch(`/search-students?q=${encodeURIComponent(q)}`);
            const data = await res.json();

            resultsList.innerHTML = "";
            if (data.students.length > 0) {
                resultsList.classList.remove("hidden");
                data.students.forEach(s => {
                    const li = document.createElement("li");
                    li.textContent = `${s.name} (${s.reg_number})`;
                    li.className = "p-2 hover:bg-indigo-100 cursor-pointer";
                    li.onclick = () => {
                        searchInput.value = `${s.name} (${s.reg_number})`;
                        hiddenId.value = s.id;
                        resultsList.classList.add("hidden");
                        studentNameSpan.textContent = s.name;
                        studentClassSpan.textContent = s.student_class;
                        fetchStudentFinancials();
                    };
                    resultsList.appendChild(li);
                });
            } else {
                resultsList.classList.add("hidden");
                studentInfoDiv.classList.add("hidden");
            }
        } catch (err) {
            alert("⚠️ Error searching students.");
        }
    });

    termSelect.addEventListener("change", fetchStudentFinancials);
    sessionInput.addEventListener("input", fetchStudentFinancials);

    // --- HANDLE PAYMENT SUBMISSION ---
    paymentForm.addEventListener("submit", async function(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = "Saving...";

        const formData = new FormData(paymentForm);

        try {
            const response = await fetch('/add-payment', { method: 'POST', body: formData });

            if (response.headers.get("content-type")?.includes("application/json")) {
                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    receiptDetails.innerHTML = `
                        <p><strong>Student:</strong> ${result.student_name}</p>
                        <p><strong>Class:</strong> ${result.student_class}</p>
                        <p><strong>Amount Paid:</strong> ₦${formatCurrency(result.amount_paid)}</p>
                        <p><strong>Payment Type:</strong> ${result.payment_type}</p>
                        <p><strong>Term:</strong> ${result.term}</p>
                        <p><strong>Session:</strong> ${result.session}</p>
                        <p><strong>Date:</strong> ${result.date}</p>
                    `;
                    receiptModal.classList.remove("hidden");
                }
            } else {
                window.location.reload(); // fallback redirect
            }
        } catch (err) {
            alert("⚠️ Error saving payment.");
        }

        submitBtn.disabled = false;
        submitBtn.textContent = "Save Payment";
    });

    // --- CLOSE RECEIPT MODAL ---
    closeReceiptModal.addEventListener("click", () => {
        receiptModal.classList.add("hidden");
    });
</script>
{% endblock %}
